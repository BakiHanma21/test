<div class="dashboard-header" [ngClass]="{'header-shifted': !sidebarOpen}">
  <div class="sidebar-toggle-container">
    <button class="sidebar-toggle-inside" (click)="toggleSidebar()" title="Toggle Sidebar">☰</button>
    <span class="welcome-message">Welcome Admin!</span>
  </div>
</div>

<div class="dashboard-container">
  <!-- Sidebar Navigation -->
  <div class="sidebar" [class.open]="sidebarOpen">
    <div class="sidebar-header">
      <div class="logo">
        <img src="assets/matain-logo-copy.png" alt="Company Logo" />
        <p class="pol">User Management System</p>
      </div>
      <button class="close-sidebar" (click)="toggleSidebar()" title="Close Sidebar">×</button>
    </div>
    <hr class="logo-line" />
    
    <nav class="sidebar-nav">
      <h4 class="menu-title">Menu</h4>
      <ul class="nav-links">
        <li>
          <a routerLink="/dashboard-management" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }">
            <i class="fas fa-tachometer-alt"></i> <span>Dashboard</span>
          </a>
        </li>
        <li>
          <a routerLink="/profile-management" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }">
            <i class="fas fa-user"></i> <span>Profile</span>
          </a>
        </li>
        <li>
          <a routerLink="/role-based-access-control" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }">
            <i class="fas fa-users-cog"></i> <span>Role-Based Access</span>
          </a>
        </li>
        <li>
          <a routerLink="/user-verification" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }">
            <i class="fas fa-check-circle"></i> <span>Verifications</span>
          </a>
        </li>
        <li>
          <a routerLink="/admin-messages" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }">
            <i class="fas fa-comment"></i> <span>Messages</span>
          </a>
        </li>
      </ul>
    </nav>
    
    <div class="logout">
      <a (click)="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </a>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="main-content" [ngStyle]="{ 'margin-left': sidebarOpen ? '250px' : '0' }">
    <div class="messenger-container">
      <!-- Connection status indicator -->
      <div class="connection-status" [class.connected]="isConnected" [class.disconnected]="!isConnected">
        <span class="status-dot"></span>
        {{ isConnected ? 'Connected' : 'Connecting...' }}
      </div>

      <div class="messenger">
        <!-- Conversations Side Panel -->
        <div class="conversations-panel" [class.show-conversations]="showConversations || !isMobileView">
          <div class="conversations-header">
            <h2>Messages</h2>
            <button class="close-conversations-btn" *ngIf="isMobileView" (click)="toggleConversations()" title="Close conversations list">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input 
              type="text" 
              class="search-input" 
              placeholder="Search conversations..."
              [(ngModel)]="searchText"
              (input)="onSearch()">
          </div>
          
          <div class="conversations-list">
            <div class="conversation-item" 
              *ngFor="let conv of conversations" 
              [class.active]="conv.id === receiverId" 
              (click)="selectConversation(conv.id)">
              <div class="conversation-avatar">
                {{ conv.name.charAt(0).toUpperCase() }}
              </div>
              <div class="conversation-info">
                <div class="conversation-name">
                  <span>{{ conv.name }}</span>
                  <span class="conversation-time" *ngIf="conv.latest_timestamp">{{ conv.latest_timestamp | date:'shortTime' }}</span>
                </div>
                <div class="conversation-preview">
                  <p class="preview-text">{{ conv.role }}</p>
                  <span class="unread-badge" *ngIf="conv.unread_count > 0">{{ conv.unread_count }}</span>
                </div>
              </div>
            </div>
            
            <div *ngIf="conversations.length === 0" class="no-conversations">
              <div class="empty-state">
                <i class="fas fa-comments"></i>
                <p *ngIf="searchText">No conversations found</p>
                <p *ngIf="!searchText">No conversations yet</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
          <!-- Mobile toggle button -->
          <button class="mobile-toggle-conversations" (click)="toggleConversations()" *ngIf="isMobileView" title="Show conversations">
            <i class="fas" [class.fa-bars]="!showConversations" [class.fa-times]="showConversations"></i>
          </button>

          <!-- Chat Content -->
          <div class="chat-content" *ngIf="receiverId; else welcomeMessage">
            <!-- Chat Header -->
            <div class="chat-header">
              <div class="chat-user-info" *ngIf="selectedConversation">
                <div class="user-avatar">
                  {{ selectedConversation.name.charAt(0).toUpperCase() }}
                </div>
                <div class="user-details">
                  <h3>{{ selectedConversation.name }}</h3>
                  <span class="user-status">{{ selectedConversation.role }}</span>
                </div>
              </div>
              <div class="chat-actions">
                <button class="action-button" (click)="viewProfile()" *ngIf="selectedConversation" title="View Profile">
                  <i class="fas fa-user-circle"></i>
                </button>
              </div>
            </div>
            
            <!-- Messages Area -->
            <div class="messages-container" #messageContainer>
              <div *ngFor="let msg of messages" 
                   class="message"
                   [class.sent]="msg.sender_id === currentUserId" 
                   [class.received]="msg.sender_id !== currentUserId">
                <div class="message-bubble">
                  <p *ngIf="msg.message">{{ msg.message }}</p>
                  
                  <!-- Image Preview -->
                  <div class="media-content" *ngIf="msg.file_url && isImageType(msg.file_type)">
                    <img [src]="msg.file_url" 
                         alt="Shared image" 
                         class="message-image"
                         (error)="onImageError($event)">
                  </div>
                  
                  <!-- File Attachment -->
                  <div class="file-attachment" *ngIf="msg.file_url && !isImageType(msg.file_type)">
                    <i class="fas fa-file"></i>
                    <a [href]="msg.file_url" target="_blank" class="file-name">
                      {{ msg.file_name || 'Attachment' }}
                    </a>
                  </div>
                </div>
                <div class="message-meta">
                  <span class="message-time">{{ msg.created_at | date:'shortTime' }}</span>
                  <span class="message-status" *ngIf="msg.sender_id === currentUserId">
                    <i class="fas" [class.fa-check]="!msg.read_at" [class.fa-check-double]="msg.read_at"></i>
                  </span>
                </div>
              </div>
            </div>
            
            <!-- Error Message -->
            <div *ngIf="errorMessage" class="error-message">
              <i class="fas fa-exclamation-circle"></i>
              {{ errorMessage }}
            </div>
            
            <!-- Message Input Area -->
            <form (ngSubmit)="sendMessage()" enctype="multipart/form-data" class="message-form">
              <div class="attachment-btn">
                <label for="file-input" title="Attach file">
                  <i class="fas fa-paperclip"></i>
                </label>
                <input 
                  type="file" 
                  id="file-input"
                  #fileInput 
                  title="Select file to attach"
                  (change)="onFileSelected($event)"
                  [disabled]="isSending || !!errorMessage">
              </div>
              
              <div class="input-wrapper">
                <input 
                  type="text"
                  [(ngModel)]="newMessage" 
                  name="message" 
                  placeholder="Type a message..." 
                  [disabled]="isSending || !!errorMessage"
                  (keyup.enter)="sendMessage()">
              </div>

              <button 
                type="submit" 
                class="send-btn"
                title="Send message"
                [disabled]="isSending || (!newMessage.trim() && !selectedFile) || !isConnected || !!errorMessage">
                <i class="fas" [class.fa-paper-plane]="!isSending" [class.fa-spinner]="isSending"></i>
              </button>
            </form>
          </div>

          <!-- Welcome Message Template -->
          <ng-template #welcomeMessage>
            <div class="welcome-screen">
              <div class="welcome-icon">
                <i class="fas fa-comments"></i>
              </div>
              <h2>Welcome to Messages</h2>
              <p>Select a conversation to start chatting</p>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Backdrop/Overlay for Mobile -->
  <div class="sidebar-backdrop" *ngIf="sidebarOpen" (click)="toggleSidebar()"></div>
</div>